!function(e,t){if("function"==typeof define&&define.amd)define(["module","exports"],t);else if("undefined"!=typeof exports)t(module,exports);else{var n={exports:{}};t(n,n.exports),e.FFT=n.exports}}(this,function(e,t){"use strict";function n(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0});var r=function(){function e(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}(),a=function(){function e(){n(this,e)}return r(e,null,[{key:"getHammingWindow",value:function(e){for(var t=1/e/.54,n=Math.sqrt(e),r=2*Math.PI/e,a=[],i=0;i<e;i++)a[i]=n*(t*(25/46-21/46*Math.cos(r*i)));return a}},{key:"getSpectrum",value:function(e,t){var n=e.length,r=Math.round(Math.log(n)/Math.log(2)),a=2*Math.PI;if(n!=1<<r)throw new Error("FFT data must be power of 2");for(var i=void 0,o=0,s=0;s<n-1;s++){if(s<o){var l=e[o];e[o]=e[s],e[s]=l,l=t[o],t[o]=t[s],t[s]=l}for(var f=n/2;f>=1&&f-1<o;)o-=f,f/=2;o+=f}for(var c=1;c<=r;c++){i=1<<c;var u=1,h=0,v=a/i,d=Math.cos(v),p=-1*Math.sin(v),g=i/2;for(o=0;o<g;o++){for(var m=o;m<n;m+=i){var y=m+g,b=u*e[y]-h*t[y],x=u*t[y]+h*e[y];e[y]=e[m]-b,t[y]=t[m]-x,e[m]+=b,t[m]+=x}var I=u;u=d*u-p*h,h=d*h+p*I}}for(var w=0;w<e.length;w++){var M=e[w]*e[w]+t[w]*t[w];e[w]=M}for(var T=0;T<e.length;T++)e[T]=Math.sqrt(e[T])}}]),e}();t.default=a,e.exports=t.default}),function(e,t){if("function"==typeof define&&define.amd)define(["module","exports"],t);else if("undefined"!=typeof exports)t(module,exports);else{var n={exports:{}};t(n,n.exports),e.OnsetDetection=n.exports}}(this,function(e,t){"use strict";function n(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0});var r=function(){function e(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}(),a=function(){function e(){n(this,e)}return r(e,null,[{key:"calculateSF",value:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};if(void 0===t)throw new ReferenceError("fft is undefined");if("function"!=typeof t.getHammingWindow||"function"!=typeof t.getSpectrum)throw new ReferenceError("fft doesn't contain getHammingWindow or getSpectrum methods");Array.prototype.fill||(Array.prototype.fill=function(e){if(null==this)throw new TypeError("this is null or not defined");for(var t=Object(this),n=t.length>>>0,r=arguments[1],a=r>>0,i=a<0?Math.max(n+a,0):Math.min(a,n),o=arguments[2],s=void 0===o?n:o>>0,l=s<0?Math.max(n+s,0):Math.min(s,n);i<l;)t[i]=e,i++;return t}),n.bufferSize=n.bufferSize||2048,n.hopSize=n.hopSize||441;var r=n.bufferSize,a=n.hopSize,i=Math.floor(Math.log(r)/Math.LN2);if(Math.pow(2,i)!==r)throw"Invalid buffer size ("+r+"), must be power of 2";var o=t.getHammingWindow(r),s=[],l=r/2+1,f=new Array(l);f.fill(0);var c=new Array(r),u=e.length,h=new Array(r-a);h.fill(0),e=h.concat(e);var v=new Array(r-e.length%a);v.fill(0),e=e.concat(v);for(var d=0;d<u;d+=a){for(var p=d+r,g=[],m=0,y=d;y<p;y++)g[m]=o[m]*e[y],m++;c.fill(0),t.getSpectrum(g,c);for(var b=0,x=0;x<l;x++){var I=g[x]-f[x];b+=I<0?0:I}s.push(b),f=g}return s}},{key:"normalize",value:function(e){if(!Array.isArray(e))throw"Array expected";if(0==e.length)throw"Array is empty";for(var t=0,n=0,r=0;r<e.length;r++)t+=e[r],n+=e[r]*e[r];var a=t/e.length,i=Math.sqrt((n-t*a)/e.length);0==i&&(i=1);for(var o=0;o<e.length;o++)e[o]=(e[o]-a)/i}},{key:"findPeaks",value:function(e){for(var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},n=e.length,r=e,a=t.decayRate||.84,i=t.peakFindingWindow||6,o=t.meanWndMultiplier||3,s=t.peakThreshold||.35,l=r[0],f=[],c=0;c<n;c++)if(l=a*l+(1-a)*r[c],!(r[c]<l)){var u=c-i,h=c+i+1;u<0&&(u=0),h>n&&(h=n),l<r[c]&&(l=r[c]);for(var v=!0,d=u;d<h;d++)r[d]>r[c]&&(v=!1);if(v){var p=c-i*o,g=c+i;p<0&&(p=0),g>n&&(g=n);for(var m=0,y=g-p,b=p;b<g;b++)m+=r[b];r[c]>m/y+s&&f.push(c)}}if(f.length<2)throw"Fail to find peaks";return f}}]),e}();t.default=a,e.exports=t.default}),function(e,t){if("function"==typeof define&&define.amd)define(["module","exports"],t);else if("undefined"!=typeof exports)t(module,exports);else{var n={exports:{}};t(n,n.exports),e.TempoInduction=n.exports}}(this,function(e,t){"use strict";function n(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0});var r=function(){function e(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}(),a=function(){function e(){n(this,e)}return r(e,null,[{key:"processRhythmicEvents",value:function(e){for(var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},n=t.widthTreshold||.025,r=t.maxIOI||2.5,a=t.minIOI||.07,i=e.length,o=[],s=[],l=0,f=0;f<i-1;f++)for(var c=f+1;c<i;c++){var u=e[c]-e[f];if(!(u<a)){if(u>r)break;for(var h=0;h<l;h++)if(Math.abs(o[h]-u)<n){Math.abs(o[h+1]-u)<Math.abs(o[h]-u)&&h<l-1&&h++,o[h]=(o[h]*s[h]+u)/(s[h]+1),s[h]++;break}if(h==l){for(l++;h>0&&o[h-1]>u;h--)o[h]=o[h-1],s[h]=s[h-1];o[h]=u,s[h]=1}}}if(0==l)throw"Fail to find IOIs";return o.length=l,s.length=l,{clIntervals:o,clSizes:s}}},{key:"mergeClusters",value:function(e){for(var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},n=t.widthTreshold||.025,r=e.clIntervals,a=e.clSizes,i=r.length,o=0;o<i;o++)for(var s=o+1;s<i;s++)if(Math.abs(r[o]-r[s])<n){r[o]=(r[o]*a[o]+r[s]*a[s])/(a[o]+a[s]),a[o]=a[o]+a[s],--i;for(var l=s+1;l<=i;l++)r[l-1]=r[l],a[l-1]=a[l]}return r.length=i,a.length=i,{clIntervals:r,clSizes:a}}},{key:"calculateScore",value:function(e){for(var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},n=t.widthTreshold||.025,r=t.maxTempos||10,a=e.clIntervals,i=e.clSizes,o=[],s=[],l=a.length,f=0;f<l;f++)o[f]=10*i[f],s[f]={score:o[f],idx:f};if(s.sort(function(e,t){return t.score-e.score}),s.length>r){for(var c=r-1;c<s.length-1&&s[c].score==s[c+1].score;c++)r++;s.length=r}s=s.map(function(e){return e.idx});for(var u=0;u<l;u++)for(var h=u+1;h<l;h++){var v=a[u]/a[h],d=v<1,p=void 0,g=void 0;if(!((p=d?Math.round(1/v):Math.round(v))<2||p>8)){g=d?Math.abs(a[u]*p-a[h]):Math.abs(a[u]-a[h]*p);var m=d?n:n*p;g>=m||(p=p>=5?1:6-p,o[u]+=p*i[h],o[h]+=p*i[u])}}return{clScores:o,clScoresIdxs:s}}},{key:"createTempoList",value:function(e){for(var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},n=t.widthTreshold||.025,r=t.minBeatInterval||.3,a=t.maxBeatInterval||1,i=e.clIntervals,o=(e.clSizes,e.clScores),s=e.clScoresIdxs,l=[],f=i.length,c=0;c<s.length;c++){for(var u=s[c],h=i[u]*o[u],v=o[u],d=void 0,p=void 0,g=0;g<f;g++)if(g!=u){var m=i[u]/i[g],y=m<1,b=y?Math.round(1/m):Math.round(m);b<2||b>8||(y?(d=Math.abs(i[u]*b-i[g]),p=n):(d=Math.abs(i[u]-b*i[g]),p=n*b),d>=p||(h+=y?i[g]/b*o[g]:i[g]*b*o[g],v+=o[g]))}for(var x=h/v;x<r;)x*=2;for(;x>a;)x/=2;l.push(x)}return l}}]),e}();t.default=a,e.exports=t.default}),function(e,t){if("function"==typeof define&&define.amd)define(["module","exports"],t);else if("undefined"!=typeof exports)t(module,exports);else{var n={exports:{}};t(n,n.exports),e.Agent=n.exports}}(this,function(e,t){"use strict";function n(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0});var r=function(){function e(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}(),a=function(){function e(t,r,a,i){var o=arguments.length>4&&void 0!==arguments[4]?arguments[4]:{};n(this,e),this.expiryTime=o.expiryTime||10,this.toleranceWndInner=o.toleranceWndInner||.04,this.toleranceWndPre=o.toleranceWndPre||.15,this.toleranceWndPost=o.toleranceWndPost||.3,this.toleranceWndPre*=t,this.toleranceWndPost*=t,this.correctionFactor=o.correctionFactor||50,this.maxChange=o.maxChange||.2,this.penaltyFactor=o.penaltyFactor||.5,this.beatInterval=t,this.initialBeatInterval=t,this.beatTime=r,this.totalBeatCount=1,this.events=[r],this.score=a,this.agentListRef=i}return r(e,[{key:"considerEvent",value:function(e,t){if(e-this.events[this.events.length-1]>this.expiryTime)return this.score=-1,!1;var n=Math.round((e-this.beatTime)/this.beatInterval),r=e-this.beatTime-n*this.beatInterval;return n>0&&r>=-this.toleranceWndPre&&r<=this.toleranceWndPost&&(Math.abs(r)>this.toleranceWndInner&&this.agentListRef.push(this.clone()),this.acceptEvent(e,t,r,n),!0)}},{key:"acceptEvent",value:function(e,t,n,r){this.beatTime=e,this.events.push(e);var a=n/this.correctionFactor;Math.abs(this.initialBeatInterval-this.beatInterval-a)<this.maxChange*this.initialBeatInterval&&(this.beatInterval+=a),this.totalBeatCount+=r;var i=n>0?n/this.toleranceWndPost:n/-this.toleranceWndPre,o=1-this.penaltyFactor*i;this.score+=t*o}},{key:"fillBeats",value:function(){var e=void 0,t=void 0,n=void 0,r=void 0;e=0,this.events.length>2&&(e=this.events[0]);for(var a=0;a<this.events.length;a++){t=this.events[a],r=Math.round((t-e)/this.beatInterval-.01),n=(t-e)/r;for(var i=0;r>1;r--)e+=n,this.events.splice(a+i,0,e),i++;e=t}}},{key:"clone",value:function(){var t=new e;return t.beatInterval=this.beatInterval,t.initialBeatInterval=this.initialBeatInterval,t.beatTime=this.beatTime,t.totalBeatCount=this.totalBeatCount,t.events=this.events.slice(),t.expiryTime=this.expiryTime,t.toleranceWndInner=this.toleranceWndInner,t.toleranceWndPre=this.toleranceWndPre,t.toleranceWndPost=this.toleranceWndPost,t.correctionFactor=this.correctionFactor,t.maxChange=this.maxChange,t.penaltyFactor=this.penaltyFactor,t.score=this.score,t.agentListRef=this.agentListRef,t}}]),e}();t.default=a,e.exports=t.default}),function(e,t){if("function"==typeof define&&define.amd)define(["module","exports","./Agent"],t);else if("undefined"!=typeof exports)t(module,exports,require("./Agent"));else{var n={exports:{}};t(n,n.exports,e.Agent),e.BeatTracking=n.exports}}(this,function(e,t,n){"use strict";function r(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0});var a=function(e){return e&&e.__esModule?e:{default:e}}(n),i=function(){function e(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}(),o=function(){function e(){r(this,e)}return i(e,null,[{key:"trackBeat",value:function(e,t,n){function r(){f.sort(function(e,t){return e.beatInterval-t.beatInterval});for(var e=f.length,t=0;t<e;t++)if(!(f[t].score<0))for(var n=t+1;n<e&&!(f[n].beatInterval-f[t].beatInterval>s);n++)Math.abs(f[n].beatTime-f[t].beatTime)>l||(f[t].score<f[n].score?f[t].score=-1:f[n].score=-1);for(var r=e-1;r>=0;r--)f[r].score<0&&f.splice(r,1)}for(var i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:{},o=i.initPeriod||5,s=i.thresholdBI||.02,l=i.thresholdBT||.04,f=[],c=0;c<n.length;c++)f.push(new a.default(n[c],e[0],t[0],f,i));var u=1;for(r();e[u]<o;){for(var h=f.length,v=-1,d=!0,p=0;p<h;p++)f[p].beatInterval!=v&&(d||f.push(new a.default(v,e[u],t[u],f,i)),v=f[p].beatInterval,d=!1),d=f[p].considerEvent(e[u],t[u])||d;r(),u++}for(var g=e.length,m=u;m<g;m++){for(var y=f.length,b=0;b<y;b++)f[b].considerEvent(e[m],t[m]);r()}return f}}]),e}();t.default=o,e.exports=t.default}),function(e,t){if("function"==typeof define&&define.amd)define(["module","exports","./OnsetDetection","./TempoInduction","./BeatTracking","./FFT"],t);else if("undefined"!=typeof exports)t(module,exports,require("./OnsetDetection"),require("./TempoInduction"),require("./BeatTracking"),require("./FFT"));else{var n={exports:{}};t(n,n.exports,e.OnsetDetection,e.TempoInduction,e.BeatTracking,e.FFT),e.MusicTempo=n.exports}}(this,function(e,t,n,r,a,i){"use strict";function o(e){return e&&e.__esModule?e:{default:e}}function s(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0});var l=o(n),f=o(r),c=o(a),u=o(i),h=function e(t){var n=this,r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};if(s(this,e),!(t instanceof Float32Array||Array.isArray(t)))throw"audioData is not an array";var a=r.timeStep||.01,i=l.default.calculateSF(t,u.default,r);this.spectralFlux=i,l.default.normalize(this.spectralFlux),this.peaks=l.default.findPeaks(this.spectralFlux,r),this.events=this.peaks.map(function(e){return e*a});var o=f.default.processRhythmicEvents(this.events,r);o=f.default.mergeClusters(o,r);var h=f.default.calculateScore(o,r);o={clIntervals:o.clIntervals,clSizes:o.clSizes,clScores:h.clScores,clScoresIdxs:h.clScoresIdxs},this.tempoList=f.default.createTempoList(o,r);var v=this.spectralFlux.reduce(function(e,t){return Math.min(e,t)}),d=this.peaks.map(function(e){return n.spectralFlux[e]-v});this.agents=c.default.trackBeat(this.events,d,this.tempoList,r);var p=-1,g=-1;this.tempo=-1,this.beats=[],this.beatInterval=-1;for(var m=0;m<this.agents.length;m++)this.agents[m].score>p&&(p=this.agents[m].score,g=m);if(this.agents[g]&&(this.bestAgent=this.agents[g],this.bestAgent.fillBeats(),this.tempo=(60/this.bestAgent.beatInterval).toFixed(3),this.beatInterval=this.bestAgent.beatInterval,this.beats=this.bestAgent.events),-1==this.tempo)throw"Tempo extraction failed"};t.default=h,e.exports=t.default});